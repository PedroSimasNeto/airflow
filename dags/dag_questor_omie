from asyncore import read
from airflow import DAG
from airflow.decorators import task
from airflow.operators.python import PythonOperator
from airflow.operators.dummy import DummyOperator
from airflow.models import Variable
from datetime import datetime
from etl import Questor_OMIE

cfg = Variable.get("questor_omie", deserialize_json=True)

default_args = {
    "owner": "pedro",
    "start_date": datetime(2022, 11, 1)
}


@task
def dados_questor(tabelas):
    job = Questor_OMIE(schema="staging", conn="questor", table=tabelas)
    job.datalake()


with DAG("dag_questor_omie", 
         default_args=default_args, 
         schedule_interval=None, 
         tags=["questor", "omie"], 
         catchup=False) as dag:

    inicio = DummyOperator(task_id="inicio")
    fim = DummyOperator(task_id="fim")

    for t in cfg["tabelas"]:
        task_questor = dados_questor(tabelas=t)

        inicio >> task_questor >> fim
